<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>アンビシャス 請求ツール</title>
  <style>
    :root {
      --brand: #7b1e3f;        /* ワインレッド（メイン） */
      --brand-strong: #5d142e; /* 濃いワインレッド */
      --ok: #0ea5e9;
      --err: #b91c1c;
      --fg: #111;
      --muted: #6b7280;
      --bd: #e5e7eb;
      --bg: #fafafa;
    }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 24px;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      color: var(--fg); background: var(--bg);
    }
    .container { max-width: 1200px; margin: 0 auto; }

    .titlebar { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .app-title { font-size: 18px; font-weight: 800; letter-spacing: .02em; }
    .badge { font-size: 12px; color: #fff; background: var(--brand); padding: 4px 8px; border-radius: 999px; }

    .card {
      background: #fff; border: 1px solid var(--bd); border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      padding: 16px; margin-bottom: 16px;
    }
    .title {
      font: 700 16px/1.3 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      margin-bottom: 10px; color: var(--brand-strong);
    }
    .row { display:flex; gap:14px; flex-wrap: wrap; align-items: end; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 12px; color: var(--muted); }

    input[type="date"], input[type="number"] {
      padding: 10px 12px; border:1px solid var(--bd); border-radius: 10px; background:#fff; min-width: 160px; outline: none;
    }
    input[type="date"]:focus, input[type="number"]:focus {
      border-color: var(--brand); box-shadow: 0 0 0 3px rgba(123,30,63,.12);
    }

    button {
      padding: 10px 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 800;
      background: var(--brand); color: #fff; letter-spacing: .01em;
    }
    button.secondary { background: var(--brand-strong); color: #fff; }
    button.ghost { background: #fff; color: var(--fg); border: 1px solid var(--bd); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .status { font-size: 12px; color: var(--ok); }
    .error { font-size: 12px; color: var(--err); white-space: pre-wrap; }
    .muted { font-size: 12px; color: var(--muted); }

    .tableWrap { max-height: 440px; overflow: auto; border: 1px solid var(--bd); border-radius: 10px; background: #fff; }
    table { border-collapse: collapse; table-layout: fixed; width: max-content; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; font-size: 12px; text-align: left; white-space: nowrap; max-width: 360px; overflow: hidden; text-overflow: ellipsis; }
    th { background: #faf5f7; position: sticky; top: 0; z-index: 1; color: var(--brand-strong); }

    .spinner { display:inline-block; width:14px; height:14px; border:2px solid #ddd; border-top-color: var(--brand); border-radius:50%; animation: spin .8s linear infinite; vertical-align: -2px; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg);} }

    .toast {
      position: fixed; right: 16px; bottom: 16px; background: var(--brand-strong); color: #fff;
      padding: 10px 12px; border-radius: 10px; font-size: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.2);
      opacity: 0; transform: translateY(8px); transition: all .2s;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <div class="app-title">アンビシャス 請求ツール</div>
      <div class="badge">Ambitious</div>
    </div>

    <!-- ▼ 請求書（得意先マスタ） -->
    <div class="card" id="custCard">
      <div class="title">請求書CSV（得意先マスタ）</div>
      <div class="row">
        <div class="field">
          <label>請求締日</label>
          <input id="closingDateCust" type="date">
        </div>
        <button id="btnPreviewCust">プレビュー</button>
        <button id="btnCsvCust" class="secondary">CSV作成</button>
        <button id="btnPingCust" class="ghost">ヘルスチェック</button>
      </div>
      <div id="statusCust" class="status" style="margin-top:6px;"></div>
      <div id="errorCust" class="error" style="margin-top:6px;"></div>
      <div class="muted" style="margin-top:6px;">
        ルール：請求月(区分)と取引開始/終了日のロジックで抽出（当月=締日＋1Mの内包、翌月=締日の内包）<br>
        CSVは請求書ファイルレイアウトの列順で出力します。
      </div>
    </div>
    <div class="card">
      <div class="title">プレビュー（請求書CSV / 上位100件）</div>
      <div id="tableWrapCust" class="tableWrap"></div>
      <div id="countCust" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ▼ タイムチャージ -->
    <div class="card" id="tcCard">
      <div class="title">作業報告書CSV（タイムチャージ）</div>
      <div class="row">
        <div class="field">
          <label>請求対象年月</label>
          <input id="billingYmTC" type="month">
        </div>
        <button id="btnPreviewTC">プレビュー</button>
        <button id="btnCsvTC" class="secondary">CSV作成</button>
        <button id="btnPingTC" class="ghost">ヘルスチェック</button>
      </div>
      <div id="statusTC" class="status" style="margin-top:6px;"></div>
      <div id="errorTC" class="error" style="margin-top:6px;"></div>
      <div class="muted" style="margin-top:6px;">発生日の年月が対象年月と一致し、請求データ作成FLGが空欄の行のみ抽出します。</div>
    </div>
    <div class="card">
      <div class="title">プレビュー（タイムチャージCSV / 上位100件）</div>
      <div id="tableWrapTC" class="tableWrap"></div>
      <div id="countTC" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ▼ 実行履歴 -->
    <div class="card" id="historyCard" style="display:none;">
      <div class="title">実行履歴</div>
      <ul id="historyList" style="margin:0; padding-left:18px;"></ul>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      function escapeHtml(s){
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return String(s).replace(/[&<>"']/g, m=>map[m]);
      }
      function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2400); }
      function gsRunExists(targetErr){
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          if (targetErr) targetErr.textContent = 'クライアントから Apps Script 実行ができません（google.script.run が未定義）。\n'
            + '→ Webアプリとしてデプロイ済みか、正しいURLで開いているか、権限が許可されているかをご確認ください。';
          return false;
        }
        return true;
      }
      function setBusy(ids, statusEl, busy){
        ids.forEach(id=>{ const el=$(id); if(el) el.disabled = busy; });
        if (statusEl) statusEl.innerHTML = busy ? '<span class="spinner"></span>処理中…' : '';
      }
      function watchdog(statusEl, errorEl, ms=25000){
        statusEl.innerHTML = '<span class="spinner"></span>処理中…';
        const token = setTimeout(()=>{
          statusEl.innerHTML='';
          errorEl.textContent='処理が長引いています…（ネットや権限、デプロイ設定を確認してください）';
          // ボタンは呼び出し側で解除
        }, ms);
        return ()=>clearTimeout(token);
      }
      function drawTable(twoD, wrapEl, countEl){
        wrapEl.innerHTML=''; countEl.textContent='';
        if (!twoD || !twoD.length) return;
        const [header,...rows]=twoD;
        let html='<table><thead><tr>';
        header.forEach(h=> html+=`<th>${escapeHtml(h)}</th>`);
        html+='</tr></thead><tbody>';
        const max=Math.min(rows.length,100);
        for (let i=0;i<max;i++){
          html+='<tr>';
          rows[i].forEach(c=>{ const v=c==null?'':String(c); html+=`<td title="${escapeHtml(v)}">${escapeHtml(v)}</td>`;});
          html+='</tr>';
        }
        html+='</tbody></table>';
        wrapEl.innerHTML=html;
        countEl.textContent = `表示 ${max} / 合計 ${rows.length}`;
      }
      function appendHistory(html){
        const card=$('historyCard'); const ul=$('historyList'); card.style.display=''; const li=document.createElement('li');
        li.innerHTML=html; ul.prepend(li);
      }

      window.addEventListener('DOMContentLoaded', function(){
        /* ===== 請求書（得意先マスタ） ===== */
        $('btnPingCust').addEventListener('click', ()=>{
          const err=$('errorCust'), st=$('statusCust'); err.textContent='';
          if (!gsRunExists(err)) return;
          setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, true);
          const clear = watchdog(st, err, 15000);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              // 既存プロジェクトでは healthcheck() がある想定
              if (!res || (res.ok===false && !res.message)){ st.textContent = 'ヘルスチェック応答なし'; return; }
              st.textContent = (res.message || 'OK');
              toast('請求書ヘルスチェックOK');
              appendHistory(`【請求書】Ping`);
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              // healthcheck() が無い環境でも graceful にメッセージ
              err.textContent='ヘルスチェック失敗: ' + (e?.message||'（healthcheckが未実装の可能性）');
            })
            .healthcheck(); // ※なければ無視される
        });

        $('btnPreviewCust').addEventListener('click', ()=>{
          const err=$('errorCust'), st=$('statusCust'); err.textContent='';
          const closing=$('closingDateCust').value;
          if (!closing){ err.textContent='請求締日を入力してください'; return; }
          if (!gsRunExists(err)) return;
          setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, true);
          const clear = watchdog(st, err);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              if (!res || !res.ok){ err.textContent = res?.message || 'プレビュー失敗'; drawTable([], $('tableWrapCust'), $('countCust')); return; }
              drawTable(res.preview||[], $('tableWrapCust'), $('countCust'));
              st.textContent = res.message || 'プレビュー完了';
              toast('請求書プレビュー完了');
              if (res.generatedAt){ appendHistory(`【${escapeHtml(res.generatedAt)}】請求書プレビュー: ${escapeHtml(String(res.rows||0))}件`); }
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              err.textContent='プレビュー失敗: ' + (e?.message||'');
            })
            .preview_CustomersByClosing({ closingDate: closing.replace(/-/g,'/') });
        });

        $('btnCsvCust').addEventListener('click', ()=>{
          const err=$('errorCust'), st=$('statusCust'); err.textContent='';
          const closing=$('closingDateCust').value;
          if (!closing){ err.textContent='請求締日を入力してください'; return; }
          if (!gsRunExists(err)) return;
          setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, true);
          const clear = watchdog(st, err, 30000);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              if (!res || !res.ok){ err.textContent = res?.message || 'CSV作成に失敗'; return; }
              st.innerHTML = (res.message || 'CSV保存完了') + (res.url ? ` / <a href="${res.url}" target="_blank">CSV</a>` : '');
              toast('請求書CSV作成完了');
              const stamp = res.completedAt ? `【${escapeHtml(res.completedAt)}】` : '';
              const file  = res.filename ? escapeHtml(res.filename) : '(no name)';
              const cnt   = escapeHtml(String(res.rows||0));
              appendHistory(`${stamp} 請求書CSV作成: ${file}（${cnt}件）` + (res.url? ` / <a href="${res.url}" target="_blank">CSV</a>`:''));
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewCust','btnCsvCust','btnPingCust','closingDateCust'], st, false);
              err.textContent='CSV作成失敗: ' + (e?.message||'');
            })
            .createCsv_CustomersByClosing({ closingDate: closing.replace(/-/g,'/') });
        });

        /* ===== タイムチャージ ===== */
        $('btnPingTC').addEventListener('click', ()=>{
          const err=$('errorTC'), st=$('statusTC'); err.textContent='';
          if (!gsRunExists(err)) return;
          setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, true);
          const clear=watchdog(st, err, 15000);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              if (!res || !res.ok){ err.textContent='ヘルスチェック失敗'; return; }
              st.textContent = `OK ${res.lastRow}行 x ${res.lastCol}列 / ${res.at} / ${res.ms}ms`;
              toast('タイムチャージ ヘルスチェックOK');
              appendHistory(`【${escapeHtml(res.at||'') }】TC Ping: ${escapeHtml(String(res.lastRow||0))}行`);
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              err.textContent='ヘルスチェック失敗: ' + (e?.message||'');
            })
            .ping_TimeCharge();
        });

        $('btnPreviewTC').addEventListener('click', ()=>{
          const err=$('errorTC'), st=$('statusTC'); err.textContent='';
          const ym=$('billingYmTC').value;
          if (!ym){ err.textContent='請求対象年月を入力してください'; return; }
          if (!gsRunExists(err)) return;

          setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, true);
          const clear=watchdog(st, err);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              if (!res || !res.ok){ err.textContent = res?.message || 'プレビュー失敗'; drawTable([], $('tableWrapTC'), $('countTC')); return; }
              drawTable(res.preview||[], $('tableWrapTC'), $('countTC'));
              st.textContent = res.message || 'プレビュー完了';
              toast('タイムチャージ プレビュー完了');
              if (res.generatedAt){ appendHistory(`【${escapeHtml(res.generatedAt)}】TCプレビュー: ${escapeHtml(String(res.rows||0))}件`); }
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              err.textContent='プレビュー失敗: ' + (e?.message||'');
            })
            .preview_TimeCharge({ billingYm: ym });
        });

        $('btnCsvTC').addEventListener('click', ()=>{
          const err=$('errorTC'), st=$('statusTC'); err.textContent='';
          const ym=$('billingYmTC').value;
          if (!ym){ err.textContent='請求対象年月を入力してください'; return; }
          if (!gsRunExists(err)) return;

          setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, true);
          const clear=watchdog(st, err, 30000);
          google.script.run
            .withSuccessHandler(res=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              if (!res || !res.ok){ err.textContent = res?.message || 'CSV作成に失敗'; return; }
              st.innerHTML = (res.message || 'CSV保存完了') + (res.url? ` / <a href="${res.url}" target="_blank">CSV</a>` : '');
              toast('タイムチャージ CSV作成完了');
              const stamp = res.completedAt ? `【${escapeHtml(res.completedAt)}】` : '';
              const file  = res.filename ? escapeHtml(res.filename) : '(no name)';
              const cnt   = escapeHtml(String(res.rows||0));
              appendHistory(`${stamp} TC CSV作成: ${file}（${cnt}件）` + (res.url? ` / <a href="${res.url}" target="_blank">CSV</a>`:''));
            })
            .withFailureHandler(e=>{ clear(); setBusy(['btnPreviewTC','btnCsvTC','btnPingTC','billingYmTC'], st, false);
              err.textContent='CSV作成失敗: ' + (e?.message||'');
            })
            .createCsv_TimeCharge({ billingYm: ym });
        });
      });
    })();
  </script>
</body>
</html>
